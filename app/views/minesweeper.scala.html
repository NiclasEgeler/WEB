@(controller: de.htwg.se.minesweeper.controller.Controller)
@import play.api.mvc.Session

@getCellContent(cell: de.htwg.se.minesweeper.model.cell.ICell): String= @{
    if (cell.isFlagged) {
        return "🏴"
    }
    if (cell.isHidden) {
        return "?"
    }
    if (cell.isMine)
        return "💣"
    return if (cell.getValue > 0) then cell.getValue.toString() else " "
}

@getCellClass(cell: de.htwg.se.minesweeper.model.cell.ICell): String= @{
    if (cell.isFlagged) {
        return "cell-flagged"
    }
    if(cell.isMine && !cell.isHidden)
        return "cell-opened cell-mine"
    if(cell.isHidden)
        return ""
    
    "cell-opened " + (if (cell.getValue > 0) then ("cell-value-"+cell.getValue.toString()) else " ")
}

@showGameOver(cell: de.htwg.se.minesweeper.model.cell.ICell): Boolean= @{
    cell.isMine && !cell.isHidden
}

@main("Minesweeper") {
    <h1>Minesweeper</h1>
    <div id="game-container">
        <div id="game-board">
            @for(row <- 0 until controller.getGrid.getHeight){
                <div class="game-row">
                    @for(column <- 0 until controller.getGrid.getWidth){            
                        <div 
                            data-x="@row" data-y="@column"
                            class="cell @getCellClass(controller.getGrid.getCell(row, column))"
                        >
                            <span>@getCellContent(controller.getGrid.getCell(row, column))</span>
                        </div>
            
                    }
                </div>
            }
        </div>
    </div>
    <div class="buttons">
        <form action="@routes.HomeController.undo()">
            <button type="submit" class="btn btn-primary">Undo</button>
        </form>
        <form action="@routes.HomeController.redo()">
            <button type="submit" class="btn btn-primary">Redo</button>
        </form>
    </div>

    <button type="button" class="btn btn-secondary help-button" data-toggle="modal" data-target="#helpModal">
        Help
    </button>

    <div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalLabel">Game Instructions</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="list-group">
                        <li href="#" class="list-group-item list-group-item-action">Left click to open a cell</li>
                        <li href="#" class="list-group-item list-group-item-action">Right click to flag a cell</li>
                        <li href="#" class="list-group-item list-group-item-action">If you open a cell that contains a mine the game is over</li>
                        <li href="#" class="list-group-item list-group-item-action">You win the game if you open all cells that do not contain a mine</li>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    @for(row <- 0 until controller.getGrid.getHeight; column <- 0 until controller.getGrid.getWidth){
        @if(showGameOver(controller.getGrid.getCell(row, column))) {
            <div class="alert alert-danger alert-dismissible fade show mt-3 text-center" role="alert">
                You just hit a mine and the game is over. If you want to continue, you can press the undo button.
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        }
    }
    <div class="modal fade" id="gameOverModal" tabindex="-1" role="dialog" aria-labelledby="gameOverModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="gameOverModalLabel">Game Over</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              You hit a mine! Game Over. To play again undo your last move.
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" id="playAgainButton">Undo</button>
            </div>
          </div>
        </div>
    </div>
    <script type="text/javascript" src='@routes.Assets.versioned("javascripts/minesweeper.js")' type="module"></script>
}